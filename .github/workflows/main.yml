name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git \
          wget \
          unzip \
          openjdk-17-jdk \
          build-essential \
          ccache \
          libffi-dev \
          libssl-dev \
          python3-dev \
          python3-pip \
          autoconf \
          automake \
          libtool \
          cmake \
          libncurses5-dev \
          libgdbm-dev \
          libsqlite3-dev \
          zlib1g-dev \
          libbz2-dev \
          liblzma-dev \
          libreadline-dev \
          tk-dev \
          libgstreamer1.0-dev \
          libgstreamer-plugins-base1.0-dev
    
    - name: Set up Android SDK
      run: |
        mkdir -p $HOME/android-sdk
        cd $HOME/android-sdk
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mkdir -p cmdline-tools/latest
        mv cmdline-tools/* cmdline-tools/latest/
        export ANDROID_HOME=$HOME/android-sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
        
        # Accept licenses
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        
        # Install required SDK components
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"
        
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools" >> $GITHUB_ENV
    
    - name: Set up Android NDK
      run: |
        mkdir -p $HOME/android-ndk
        cd $HOME/android-ndk
        wget -q https://dl.google.com/android/repository/android-ndk-r23b-linux.zip
        unzip -q android-ndk-r23b-linux.zip
        export ANDROID_NDK_HOME=$HOME/android-ndk/android-ndk-r23b
        export ANDROID_NDK_ROOT=$ANDROID_NDK_HOME
        
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$ANDROID_NDK_HOME" >> $GITHUB_ENV
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install cython==0.29.33
        pip install kivy[base]==2.2.1
        pip install buildozer==1.5.0
    
    - name: Initialize Buildozer
      run: |
        buildozer init || true
        
        # Create or update buildozer.spec
        cat > buildozer.spec << 'EOF'
[app]
title = AiPy老板专属APK
package.name = aipy_boss_app
package.domain = com.aipy.boss
source.dir = .
source.include_exts = py,png,jpg,kv,atlas,ttf,json
version = 0.1
requirements = python3==3.9.15,kivy==2.2.1,cython==0.29.33
orientation = portrait
osx.python_version = 3
osx.kivy_version = 2.2.1
fullscreen = 0

[buildozer]
log_level = 2
warn_on_root = 1

# Android specific
android.arch = armeabi-v7a
android.ndk_path = $ANDROID_NDK_HOME
android.sdk_path = $ANDROID_SDK_ROOT
android.ndk = 23b
android.sdk = 33
android.minapi = 21
android.api = 33
android.gradle_download = True
android.accept_sdk_license = True
android.skip_update = False

# Packaging
android.allow_backup = True
android.icon = icon.png
android.adaptive_icon_foreground = icon.png
android.adaptive_icon_background = icon.png

# Permissions
android.permissions = INTERNET,ACCESS_NETWORK_STATE
android.features = 
android.manifest = 
EOF
    
    - name: Create dummy main.py if not exists
      run: |
        if [ ! -f "main.py" ]; then
          cat > main.py << 'EOF'
from kivy.app import App
from kivy.uix.label import Label

class AiPyBossApp(App):
    def build(self):
        return Label(text='AiPy Boss App')

if __name__ == '__main__':
    AiPyBossApp().run()
EOF
          echo "Created dummy main.py file"
        fi
    
    - name: Build APK (debug)
      run: |
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
        buildozer -v android debug 2>&1 | tail -100
    
    - name: Check for APK file
      run: |
        echo "Checking for APK files..."
        find . -name "*.apk" -type f | head -10
        ls -la bin/ 2>/dev/null || echo "bin directory not found"
    
    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: aipy-boss-app-apk
        path: bin/*.apk
    
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          .buildozer/
          *.log
